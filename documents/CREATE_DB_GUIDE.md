# Hướng dẫn: Thêm Bảng `Book` vào Database bằng Migration

Tài liệu này mô tả quy trình từng bước để thêm một model SQLAlchemy mới (bảng `Book`) vào dự án và sử dụng Alembic để cập nhật cấu trúc cơ sở dữ liệu.

---

### Bước 1: Tạo Model Class

Đầu tiên, chúng ta cần định nghĩa cấu trúc của bảng `book` trong một file model mới.

1.  Tạo thư mục `app/domains/book` nếu nó chưa tồn tại.
2.  Tạo file `model_book.py` với nội dung sau:

```python
# app/domains/book/model_book.py
from sqlalchemy import Column, String, DateTime

# Đường dẫn này có thể cần điều chỉnh tùy theo cấu trúc của bạn
from app.helpers.bases import BareBaseModel


class Book(BareBaseModel):
    __tablename__ = 'book'
    
    name = Column(String(200), index=True)
    author = Column(String(255))
    publishing_year = Column(DateTime)
```

### Bước 2: Đăng ký Model với Alembic

Để Alembic có thể "nhìn thấy" model `Book` mới, chúng ta cần import nó vào nơi mà Alembic sẽ quét qua. Trong dự án này, đó là file `app/helpers/__init__.py`.

- Thêm dòng sau vào cuối file `app/helpers/__init__.py`:

```python
# app/helpers/__init__.py

# ... (các dòng import khác nếu có)

# Import model mới để Alembic có thể phát hiện
from app.domains.book.model_book import Book
```

### Bước 3: Tạo File Migration

Bây giờ, hãy yêu cầu Alembic tự động tạo một script migration dựa trên model mới mà nó vừa phát hiện.

- Mở terminal và chạy lệnh:

```bash
alembic revision --autogenerate -m "Add book table"
```
*Lưu ý: `-m "Add book table"` là một thông điệp mô tả sự thay đổi, giúp bạn dễ dàng quản lý các phiên bản migration sau này.*

### Bước 4: Kiểm tra File Migration (Quan trọng!)

Sau bước trên, một file migration mới sẽ được tạo trong thư mục `alembic/versions/`. Bạn **luôn phải mở file này ra để kiểm tra** nội dung mà Alembic đã tự động tạo.

- File migration sẽ trông tương tự như sau:

```python
# alembic/versions/6f0df0651d97_add_book_table.py
"""Add book table

Revision ID: 6f0df0651d97
Revises: <ID của revision trước đó>
Create Date: 2025-09-26 15:00:00.123456

"""
# ... (imports)

def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('book',
        sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
        sa.Column('created_at', sa.DateTime(), nullable=True),
        sa.Column('updated_at', sa.DateTime(), nullable=True),
        sa.Column('name', sa.String(length=200), nullable=True),
        sa.Column('author', sa.String(length=255), nullable=True),
        sa.Column('publishing_year', sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_book_name'), 'book', ['name'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_book_name'), table_name='book')
    op.drop_table('book')
    # ### end Alembic commands ###
```

> ⚠️ **Cảnh báo:** Hãy kiểm tra kỹ các lệnh trong hàm `upgrade()`. Đôi khi, Alembic có thể tạo ra các lệnh không mong muốn (ví dụ như `op.drop_table(...)` lạ). Hãy đảm bảo script chỉ chứa những thay đổi bạn thực sự muốn.

### Bước 5: Áp dụng Migration vào Database

Sau khi đã xác nhận file migration là chính xác, hãy chạy lệnh sau để cập nhật cơ sở dữ liệu của bạn.

```bash
alembic upgrade head
```
Lệnh này sẽ thực thi script migration, tạo bảng `book` và các index tương ứng trong database.

### Bước 6: Xác nhận kết quả

Cuối cùng, sử dụng một công cụ quản lý database (như DB Browser for SQLite, DBeaver) hoặc `sqlite3` trên command line để kết nối vào database và xác nhận rằng bảng `book` đã được tạo thành công với đúng các cột.